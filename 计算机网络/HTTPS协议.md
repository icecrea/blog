# HTTPS

## HTTPS介绍

**HTTPS**（Hypertext Transfer Protocol Secure：超文本传输安全协议）是一种透过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。加密采用对称加密，但对称加密的密钥用服务器方的证书进行了非对称加密。

- 对称加密：密钥只有一个，加密解密为同一个密码，且加解密速度快，典型的对称加密算法有DES、AES等；
- 非对称加密：密钥成对出现（且根据公钥无法推知私钥，根据私钥也无法推知公钥），加密解密使用不同密钥（公钥加密需要私钥解密，私钥加密需要公钥解密），相对对称加密速度较慢，典型的非对称加密算法有RSA、DSA等。

HTTPS 默认工作在 TCP 协议443端口，它的工作流程一般如以下方式：

- 1、TCP 三次同步握手
- 2、客户端验证服务器数字证书
- 3、DH 算法协商对称加密算法的密钥、hash 算法的密钥
- 4、SSL 安全加密隧道协商完成
- 5、网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完整性保护，保证数据不被篡改。

## SSL握手过程

1. 客户端发送协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。
2. 服务端确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）
3. 客户端确认数字证书有效，然后生成一个新的随机数（Premaster secret），并使用数字证书中的公钥，加密这个随机数，发给服务端。
4. 服务端用服务端的私钥，解密获取随机数（Premaster secret）
5. 客户端和服务端使用前面的三个随机数，生成"对话密钥"（session key）来加密下面的通信过程。

握手阶段没法加密，可能被窃取加密方式和前两个随机数。所以第三个随机数不被破解决定了通信安全性。虽然理论上，只要服务器的公钥足够长（比如2048位），那么Premaster secret可以保证不被破解。但是为了足够安全，我们可以考虑把握手阶段的算法从默认的RSA算法，改为 [Diffie-Hellman算法](http://zh.wikipedia.org/wiki/迪菲－赫尔曼密钥交换)（简称DH算法）。

## HTTPS的加密思路

加密算法存在对称加密和非对称加密。对称加密效率更高。

- 对称加密： 需要保证密钥的安全。如果密钥被获取，则信息有风险。
- 非对称加密：对外公开公钥，公钥加密可以通过私钥解密，私钥加密可以公钥解密。
  - 如果只有服务端生成公钥私钥。客户端发送信息用服务端公钥加密，只有服务端能用其私钥解密，其他人无法获取客户端请求内容，但可以解密服务端发送内容。
  - 所以客户端服务端需要生成两对私钥公钥。没有密钥则无法解密通信内容。

非对称加密存在问题：**如何将公钥给对方**？比如建立连接时发送。但可能存在有人冒充服务端发送公钥进行通信。

采用**数字证书**解决这个问题。由权威部门颁发称为证书Certificate。证书里内容有公钥，证书所有者，发布机构，有效期。权威部门称为CA（ Certificate Authority）。生成证书需要发起证书请求给CA去认证，权威机构给证书卡一个章，称为**签名算法**。如何保证签名是真CA签名？通过CA的私钥。

**签名算法流程：对信息做不可逆的Hash计算，得到hash值。在发送信息时，把该hash值用CA私钥加密后作为一个签名，和信息一起发出去。**

所以从服务端不是得到公钥，而是一个证书。证书内容：Issuer，也即证书是谁颁发的；Subject，就是证书颁发给谁；Validity 是证书期限；Public-key 是公钥内容；Signature Algorithm 是签名算法。该证书有发布机构CA，只要用CA的公钥，解密签名。并且hash值也相同。则证明公钥是有效的。





参考：

https://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html

https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html

https://time.geekbang.org/column/article/9492